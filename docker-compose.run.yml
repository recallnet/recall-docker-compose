name: $project_name

services:
  cometbft:
    image: $cometbft_image
    command: run --home /cometbft
    restart: always
    volumes:
      - $workdir/cometbft:/cometbft
    user: root
    networks:
      default:
        ipv4_address: $cometbft_ip

  fendermint:
    image: $fendermint_image
    command: run
    restart: always
    volumes:
      - $workdir/fendermint:/data
      - $datadir/iroh-fendermint:/iroh-data
    env_file:
      - $workdir/generated/fendermint.env
    networks:
      default:
        ipv4_address: $fendermint_ip

  ethapi:
    image: $fendermint_image
    command: eth run
    restart: always
    volumes:
      - $workdir/fendermint:/data
    env_file:
      - $workdir/generated/ethapi.env
    depends_on:
      - fendermint
    networks:
      default:
        ipv4_address: $ethapi_ip

  objects:
    image: $fendermint_image
    command: objects run
    restart: always
    volumes:
      - $workdir/fendermint:/data
      - $datadir/iroh-objects:/iroh-data
    env_file:
      - $workdir/generated/objects.env
    depends_on:
      - fendermint
      - cometbft
    networks:
      default:
        ipv4_address: $objects_ip

  recall-exporter:
    image: $recall_exporter_image
    restart: always
    env_file:
      - $workdir/generated/recall-exporter.env
    depends_on:
      - ethapi
    networks:
      default:
        ipv4_address: $recall_exporter_ip

  prometheus:
    image: $prometheus_image
    restart: always
    volumes:
      - $workdir/prometheus/etc:/etc/prometheus
      - $workdir/prometheus/data:/prometheus
    command: >
      --config.file=/etc/prometheus/config.yml
      --storage.tsdb.retention.time=10m
    networks:
      default:
        ipv4_address: $prometheus_ip

networks:
  default:
    name: $project_name
    ipam:
      config:
        - subnet: $docker_network_subnet
